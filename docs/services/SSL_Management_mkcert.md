# SSL Management with mkcert in Grazr

This document details how Grazr handles local SSL certificate generation using a bundled `mkcert` utility. It covers the bundling of `mkcert`, its usage by `ssl_manager.py`, and the necessary steps for ensuring generated certificates are trusted by browsers. This is intended for contributors who want to understand or modify SSL-related features.

## Table of Contents

1.  [Overview of Local SSL in Grazr](#overview-of-local-ssl-in-grazr)
    * [Why mkcert?](#why-mkcert)
2.  [mkcert Bundling (`bundle_mkcert.sh`)](#mkcert-bundling-bundle_mkcertsh)
    * [Script Purpose](#script-purpose)
    * [Binary Download](#binary-download)
    * [Installation Path](#installation-path)
3.  [Configuration (`config.py` for mkcert)](#configuration-configpy-for-mkcert)
    * [Path Constants](#path-constants)
4.  [SSL Manager (`ssl_manager.py`)](#ssl-manager-ssl_managerpy)
    * [Core Responsibilities](#core-responsibilities)
    * [Certificate Generation (`generate_certificate`)](#certificate-generation-generate_certificate)
    * [Certificate Deletion (`delete_certificate`)](#certificate-deletion-delete_certificate)
    * [CA Installation (`mkcert -install`) - The Crucial Step](#ca-installation-mkcert--install---the-crucial-step)
5.  [Integration with Nginx](#integration-with-nginx)
6.  [User Experience for SSL](#user-experience-for-ssl)
7.  [Troubleshooting SSL & mkcert](#troubleshooting-ssl--mkcert)
8.  [Contributing to SSL Management](#contributing-to-ssl-management)

## 1. Overview of Local SSL in Grazr

Grazr provides a simple way to enable HTTPS for local development sites, making the local environment more closely resemble production. This is achieved by using `mkcert`, a tool that generates locally-trusted development certificates.

### Why mkcert?

* **Automatic Trust:** `mkcert` creates its own local Certificate Authority (CA) and installs it into system and browser trust stores. Certificates generated by this CA are then automatically trusted by browsers, avoiding annyoing SSL warnings.
* **Simple CLI:** It offers a straightforward command-line interface for generating certificates for various hostnames (e.g., `localhost`, `mysite.test`, `*.mysite.test`).
* **Cross-Platform:** While Grazr focuses on Linux, `mkcert` itself is cross-platform.

Grazr bundles its own `mkcert` binary to ensure version consistency and availability.

## 2. mkcert Bundling (`bundle_mkcert.sh`)

The `packaging/bundling/bundle_mkcert.sh` script is responsible for downloading the `mkcert` binary and preparing it for use by Grazr.

### Script Purpose

* Downloads a specific, known-good version of the `mkcert` binary for Linux (amd64) from its official GitHub releases.
* Makes the downloaded binary executable.
* Places it in a directory that will be included in the Grazr `.deb` package, destined for a system path like `/opt/grazr/bin/grazr-mkcert` (the exact path is defined by `config.MKCERT_BINARY`).

*(Note: The version of `bundle_mkcert.sh` in Canvas ID `bundle_mkcert_sh_for_deb` is designed to download `mkcert` to a local output directory, e.g., `./mkcert_bundle_output/mkcert`. The `.deb` packaging process would then take this binary and install it to the system path mentioned above.)*

### Binary Download

* The script fetches the `mkcert-vX.Y.Z-linux-amd64` binary from `https://github.com/FiloSottile/mkcert/releases`.
* No compilation is needed as `mkcert` is distributed as a pre-compiled Go binary.

### Installation Path

* **During `.deb` packaging:** The `mkcert` binary obtained by the bundling script is placed into the `.deb` package structure to be installed at a fixed system path (e.g., `/opt/grazr/bin/grazr-mkcert`).
* **Grazr's `config.py` (`config.MKCERT_BINARY`)** must point to this final installed location so that `ssl_manager.py` can find and use it.

## 3. Configuration (`config.py` for mkcert)

Key constants in `grazr/core/config.py` related to `mkcert`:

```python
# For where Grazr stores the certificates it generates:
CERT_DIR = CONFIG_DIR / 'certs' # e.g., ~/.config/grazr/certs/

# Path to the bundled mkcert binary after installation by the .deb package
# This path needs to be consistent with where the .deb installs it.
# Example (if installed to /opt/grazr/bin/):
MKCERT_BINARY = Path("/opt/grazr/bin/grazr-mkcert") 
# Or, if installed to /usr/local/bin by the .deb:
# MKCERT_BINARY = Path("/usr/local/bin/grazr-mkcert")

# If using the user-local bundle path directly (less common for .deb installed tool):
# MKCERT_BUNDLES_DIR = BUNDLES_DIR / 'mkcert'
# MKCERT_BINARY = MKCERT_BUNDLES_DIR / 'mkcert' 
```
It's crucial that `config.MKCERT_BINARY` points to the actual location of the `mkcert` executable that Grazr will use.

## 4. SSL Manager (`ssl_manager.py`)

The `grazr/managers/ssl_manager.py` module is responsible for all SSL certificate operations.

### Core Responsibilities
* Generating new SSL certificate and private key pairs for specified domain names using the bundled `mkcert`.
* Storing these certificates and keys in `config.CERT_DIR`.
* Deleting existing certificates and keys.
* Potentially checking if the `mkcert` local CA is installed and triggering `mkcert -install` if necessary.

### Certificate Generation (`generate_certificate`)
The `generate_certificate(domain_name)` function:
1.  Constructs the paths for the certificate file (`domain_name.pem`) and key file (`domain_name-key.pem`) within `config.CERT_DIR`.
2.  Forms the command to run `mkcert`:
    ```bash
    /path/to/grazr-mkcert -cert-file /path/to/certs/domain.pem -key-file /path/to/certs/domain-key.pem "domain.name" "*.domain.name"
    ```
    (It typically generates for both the bare domain and a wildcard subdomain).
3.  Executes this command using `subprocess.run()`.
4.  Returns success/failure and any messages.
    * **`CAROOT` Environment Variable:** It's important that when `mkcert` is run by Grazr (as the user), it uses the user's `CAROOT` (Certificate Authority root directory, typically `~/.local/share/mkcert`). This ensures the certificates are signed by the CA that the user has installed and trusts. `mkcert` usually determines this automatically.

### Certificate Deletion (`delete_certificate`)
The `delete_certificate(domain_name)` function:
1.  Constructs the paths for the certificate and key files in `config.CERT_DIR`.
2.  Deletes these files.

### CA Installation (`mkcert -install`) - The Crucial Step
For the certificates generated by `mkcert` to be trusted by browsers and other tools on the local machine, `mkcert`'s local Certificate Authority (CA) root certificate must be installed in the system and browser trust stores.
* **This is done by running `mkcert -install` once per machine/user profile.**
* **Grazr's Role:**
    * The `.deb` package's `postinst` script (which runs as root) **should not** run `mkcert -install` because the CA created would be for the root user, not the actual desktop user.
    * Instead, the **Grazr application itself** (e.g., within `ssl_manager.py` or a first-run setup utility) should handle this:
        1.  When a user first tries to enable SSL for a site, or on Grazr's first launch.
        2.  Grazr checks if the `mkcert` CA is already installed for the current user. This can be done by checking if `$(mkcert -CAROOT)/rootCA.pem` exists, or by attempting a dummy certificate generation that might trigger `mkcert` to report if the CA isn't installed.
        3.  If the CA is not installed, Grazr executes the command:
            `config.MKCERT_BINARY -install`
            This command runs as the **current logged-in user**.
        4.  `mkcert` itself is designed to detect if it needs to modify system-wide trust stores (like `/usr/local/share/ca-certificates/` or browser NSS databases). If it does, **`mkcert` will invoke `sudo` internally** and the user will see a standard system password prompt.
        5.  This way, the user grants permission through a familiar mechanism, and the CA is installed correctly for their user context and system-wide if `mkcert` deems it necessary and obtains sudo permission.

This approach ensures that Grazr uses its bundled `mkcert`, the CA is correctly installed for the user, and manual steps for the user are minimized to just responding to a standard `sudo` prompt if `mkcert` requires it.

## 5. Integration with Nginx

When SSL is enabled for a site in Grazr:
1.  `ssl_manager.generate_certificate()` creates the `cert.pem` and `key.pem` in `config.CERT_DIR/domain_name/`.
2.  `site_manager.update_site_settings()` updates the site's configuration in `sites.json` to mark `https: true`.
3.  `nginx_manager.generate_site_config()` (when called by `install_nginx_site`) detects that SSL is enabled and generates an Nginx server block that:
    * Listens on port 443 ssl http2.
    * Includes `ssl_certificate /path/to/config.CERT_DIR/domain_name/domain_name.pem;`
    * Includes `ssl_certificate_key /path/to/config.CERT_DIR/domain_name/domain_name-key.pem;`
    * May include other SSL best-practice directives (protocols, ciphers).
4.  Nginx is then reloaded to apply the new configuration.

## 6. User Experience for SSL

* When a user enables SSL for a site:
    * If `mkcert -install` hasn't been run for them yet, Grazr should trigger it. The user might see a `sudo` prompt from `mkcert`.
    * Grazr generates the certificate.
    * Grazr updates the Nginx configuration for that site.
    * The site should then be accessible via `https://domain.test` without browser warnings.

## 7. Troubleshooting SSL & mkcert

* **"Certificate not trusted" errors in browser:**
    * Verify `mkcert -install` was run successfully for the current user. Check the contents of `$(mkcert -CAROOT)` (usually `~/.local/share/mkcert`) for `rootCA.pem`.
    * Ensure browsers were restarted after `mkcert -install` was run.
    * Some browsers (especially Firefox if not using the system NSS store) might require their own import of the `rootCA.pem` if `mkcert -install` couldn't update their specific trust store. `mkcert` usually handles this for common Firefox/Chrome setups.
* **`mkcert` command fails in `ssl_manager.py`:**
    * Ensure `config.MKCERT_BINARY` points to a valid, executable `mkcert` binary.
    * Check permissions on `config.CERT_DIR` (Grazr needs to write certificates there).
    * Check `stderr` from the `mkcert` subprocess call for error messages.
* **Nginx SSL errors (e.g., "no SSL certificate" in Nginx logs):**
    * Verify the `ssl_certificate` and `ssl_certificate_key` paths in the Nginx site configuration are correct and point to existing files in `config.CERT_DIR`.
    * Check Nginx error logs for details.

## 8. Contributing to SSL Management

* Improving the detection of whether `mkcert -install` needs to be run.
* Enhancing error handling and user feedback during certificate generation and CA installation.
* Adding UI elements to show the status of the mkcert local CA or to re-trigger `mkcert -install`.